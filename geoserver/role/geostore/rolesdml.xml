<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
  <comment>DML statements for role database</comment>
  <!-- roles are the groups + GEOSTORE + geostore roles -->
  <entry key="roles.count">
    SELECT sum(c) FROM (SELECT count(*)+1  AS c  FROM gs_usergroup UNION SELECT count(distinct user_role) AS c FROM gs_user )AS b  </entry>
  <entry key="roles.all">
	SELECT groupname,'GEOSTORE' as parent from gs_usergroup UNION SELECT 'GEOSTORE',NULL UNION SELECT DISTINCT user_role,NULL from gs_user
  </entry>
  <entry key="roles.keyed">
	SELECT CASE WHEN ? IN (SELECT groupname FROM gs_usergroup) THEN 'GEOSTORE' ELSE NULL END
  </entry>
  <entry key="roles.insert">
	insert into gs_usergroup (id,groupname) values (nextval('hibernate_sequence'),?)
  </entry>
  <!-- nothing to update at the moment, use dummy statement -->
  <entry key="roles.update">
	update gs_usergroup set groupname=groupname where groupname = ?
  </entry>  
  <entry key="roles.parentUpdate">
	update gs_usergroup set groupname=groupname where groupname = ?
  </entry>
  <entry key="roles.deleteParent">
	update gs_usergroup set groupname=groupname where groupname = ?
  </entry>
  <entry key="roles.delete">
	delete from gs_usergroup where name = ?
  </entry>
  <entry key="roles.deleteAll">
	delete from gs_usergroup 
  </entry>
  
  <!-- not implemented -->
  <entry key="roleprops.all">
	select 1,1,1
  </entry>
  <entry key="roleprops.selectForRole">
	select NULL,NULL from  gs_usergroup where groupname = ?
  </entry>
  <entry key="roleprops.selectForUser">
	select NULL,NULL,NULL from  gs_usergroup p,gs_user u where p.id = u.id and u.name = ?
  </entry>
  <entry key="roleprops.selectForGroup">
	select NULL,NULL,NULL from  gs_usergroup p,gs_user u where p.id = u.id and u.name = ?
  </entry>    
  <entry key="roleprops.deleteForRole">
	Select 1
  </entry>
  <entry key="roleprops.insert">
	Select 1 where ? = ? AND ? = '1'
  </entry>
  <entry key="roleprops.deleteAll">
	Select 1
  </entry>
   <!-- not implemented -->
   <!-- Mapping of GeoStore groups as roles in GeoServer -->
  <entry key="userroles.rolesForUser">
    select CASE WHEN ? = 'admin'  THEN 'ADMIN' ELSE 'USER' END,NULL
  </entry>
  <entry key="userroles.usersForRole">
	SELECT u.name FROM (SELECT name,user_role FROM gs_user UNION (SELECT  u.name,g.groupname FROM gs_user u,gs_usergroup g, gs_usergroup_members m WHERE u.id=m.user_id AND g.id = m.group_id)    from user_roles where rolename = ?
  </entry>
  <entry key="userroles.insert">
	select NULL from gs_user where name = ?
  </entry>
  <entry key="userroles.delete">
	select NULL from gs_user where name = ?
  </entry>
  <entry key="userroles.deleteRole">
	select NULL from gs_user where name = ?
  </entry>
  <entry key="userroles.deleteUser">
	select NULL from gs_user where name = ?
  </entry>
  <entry key="userroles.deleteAll">
	select NULL ;
  </entry>



  <entry key="grouproles.rolesForGroup">
	SELECT DISTINCT g.groupname,'GEOSTORE' as parent  FROM gs_user u JOIN gs_usergroup_members m ON u.id = m.user_id JOIN  gs_usergroup g on m.group_id = g.id WHERE g.groupname= ? 
  </entry>
  <entry key="grouproles.groupsForRole">
	select groupname for gs_usergroup where groupname = ?
  </entry>
  <entry key="grouproles.insert">
	insert into group_roles(rolename,groupname) values (?,?)
  </entry>
  <entry key="grouproles.delete">
	delete from group_roles where rolename=? and groupname = ?
  </entry>
  <entry key="grouproles.deleteRole">
	delete from group_roles where rolename=? 
  </entry>
  <entry key="grouproles.deleteGroup">
	delete from group_roles where groupname = ?
  </entry>
    <entry key="grouproles.deleteAll">
	delete from group_roles  
  </entry>
  
	  
</properties>
